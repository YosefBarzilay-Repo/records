<!DOCTYPE html>
<html dir="rtl" lang="he"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Feeling Good - הגדרות</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link href="style.css" rel="stylesheet" />
<style>
    .material-symbols-outlined.filled {
        font-variation-settings: 'FILL' 1;
    }
  </style>
  </head>
<body>
    <div class="main-container">
        <header class="app-header">
            <div class="header-content">
                <div class="header-action-placeholder">
                    <a href="index.html" class="icon-btn">
                        <span class="material-symbols-outlined">arrow_forward</span>
                    </a>
                </div>
                <h1 class="header-title">הגדרות</h1>
                <div class="header-action-placeholder"></div>
            </div>
        </header>
        <main>
            <div class="content-wrapper space-y-4">
                <div class="card">
                    <h2 class="text-lg font-bold mb-2">ייצוא נתונים</h2>
                    <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">ייצא את כל רשומות המחשבה שלך לקובץ CSV.</p>
                    <button id="export-csv-btn" class="btn btn-primary btn-full">
                        <span class="material-symbols-outlined">download</span>
                        <span>ייצוא הכל ל-CSV</span>
                    </button>
                </div>
                <div class="card">
                    <h2 class="text-lg font-bold mb-2">ייצוא תוצאות מבחנים</h2>
                    <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">ייצא את כל תוצאות מבחני הדיכאון שלך לקובץ CSV.</p>
                    <button id="export-tests-csv-btn" class="btn btn-primary btn-full">
                        <span class="material-symbols-outlined">download</span>
                        <span>ייצוא תוצאות מבחנים</span>
                    </button>
                </div>
                <div class="card">
                    <h2 class="text-lg font-bold mb-4">רשומות בארכיון</h2>
                    <div id="archive-container" class="space-y-4"></div>
                </div>
                <div class="card">
                    <h2 class="text-lg font-bold mb-4">מבחנים בארכיון</h2>
                    <div id="archived-tests-container" class="space-y-4"></div>
                </div>
            </div>
        </main>
        <footer class="app-footer">
            <nav class="footer-nav">
                <a class="nav-link w-1/3" href="index.html" title="רשומות">
                    <span class="material-symbols-outlined">description</span>
                </a>
                <a class="nav-link w-1/3" href="test_history.html" title="היסטוריית מבחנים">
                    <span class="material-symbols-outlined">checklist_rtl</span>
                </a>
                <a class="nav-link w-1/3 active" href="settings.html" title="הגדרות">
                    <span class="material-symbols-outlined filled">settings</span>
                </a>
            </nav>
        </footer>
        <!-- Custom Modal -->
        <div id="custom-modal" class="modal-backdrop">
            <div class="modal-content" style="text-align: center;">
                <h3 id="custom-modal-title" class="modal-title"></h3>
                <p id="custom-modal-message" class="modal-body"></p>
                <div id="custom-modal-buttons" class="modal-footer">
                    <!-- Buttons are injected here -->
                </div>
            </div>
        </div>
    </div>
<script>
    // --- Suppress Tailwind CDN production warning ---
    const originalWarn = console.warn;
    console.warn = function(message) {
        if (message.includes('cdn.tailwindcss.com should not be used in production')) {
            return;
        }
        originalWarn.apply(console, arguments);
    };
    // ---------------------------------------------

    document.addEventListener('DOMContentLoaded', () => {
        const exportBtn = document.getElementById('export-csv-btn');
        const exportTestsBtn = document.getElementById('export-tests-csv-btn');
        const archiveContainer = document.getElementById('archive-container');
        const archivedTestsContainer = document.getElementById('archived-tests-container');
        const customModal = document.getElementById('custom-modal');
        const customModalTitle = document.getElementById('custom-modal-title');
        const customModalMessage = document.getElementById('custom-modal-message');
        const customModalButtons = document.getElementById('custom-modal-buttons');

        let confirmResolve = null;

        // Close modal if backdrop is clicked
        customModal.addEventListener('click', (e) => { if (e.target === customModal) showCustomModal(false); });

        function escapeCsvCell(cellData) {
            if (cellData == null) { // Check for null or undefined
                return '';
            }
            const stringData = String(cellData);
            // If the cell contains a comma, a newline, or a double quote, enclose it in double quotes.
            if (stringData.includes(',') || stringData.includes('\n') || stringData.includes('"')) {
                // Escape existing double quotes by doubling them.
                return `"${stringData.replace(/"/g, '""')}"`;
            }
            return stringData;
        }

        function exportToCsv() {
            const records = JSON.parse(localStorage.getItem('thoughtRecords')) || [];
            if (records.length === 0) {
                showCustomAlert('אין רשומות לייצוא', 'ייצוא נתונים');
                return;
            }

            const headers = ['ID', 'תאריך יצירה', 'מחשבה אוטומטית', 'עיוות הכרני', 'תגובה הגיונית'];
            const rows = records.map(record => [
                record.id,
                new Date(record.createdAt).toLocaleString('he-IL'),
                record.thought,
                Array.isArray(record.distortion) 
                    ? record.distortion.join('; ') 
                    : record.distortion,
                record.response
            ].map(escapeCsvCell));

            let csvContent = headers.join(',') + '\n';
            rows.forEach(rowArray => {
                csvContent += rowArray.join(',') + '\n';
            });

            // BOM for Excel to recognize UTF-8
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const date = new Date().toISOString().slice(0, 10);
            link.setAttribute("download", `thought_records_${date}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportTestsToCsv() {
            const testResults = JSON.parse(localStorage.getItem('depressionTestResults')) || [];
            if (testResults.length === 0) {
                showCustomAlert('אין תוצאות מבחנים לייצוא', 'ייצוא נתונים');
                return;
            }

            const questionHeaders = Array.from({ length: 25 }, (_, i) => `שאלה ${i + 1}`);
            const headers = ['תאריך', 'ציון', 'רמה', ...questionHeaders];

            const rows = testResults.map(result => {
                const baseData = [
                    new Date(result.createdAt).toLocaleString('he-IL'),
                    result.score,
                    result.level
                ];
                const answerData = result.answers ? result.answers : new Array(25).fill('');
                return [...baseData, ...answerData].map(escapeCsvCell);
            });

            let csvContent = headers.join(',') + '\n';
            rows.forEach(rowArray => {
                csvContent += rowArray.join(',') + '\n';
            });

            // BOM for Excel to recognize UTF-8
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const date = new Date().toISOString().slice(0, 10);
            link.setAttribute("download", `depression_test_results_${date}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function renderArchivedRecords() {
            let archivedRecords = JSON.parse(localStorage.getItem('archivedRecords')) || [];
            archiveContainer.innerHTML = '';

            if (archivedRecords.length === 0) {
                archiveContainer.innerHTML = `<p class="text-sm text-slate-500 dark:text-slate-400 text-center">הארכיון ריק.</p>`;
                return;
            }

            archivedRecords.forEach(record => {
                const recordElement = document.createElement('div');
                recordElement.className = 'archived-item';
                recordElement.dataset.id = record.id;
                recordElement.innerHTML = `
                    <div class="archived-item-text">
                        <p class="archived-item-title">${record.thought}</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400" style="font-size: 0.75rem;">${new Date(record.createdAt).toLocaleDateString('he-IL')}</p>
                    </div>
                    <div class="archived-item-actions">
                        <button title="שחזר" class="restore-btn icon-btn" style="color: #16a34a;">
                            <span class="material-symbols-outlined text-base pointer-events-none">unarchive</span>
                        </button>
                        <button title="מחק לצמיתות" class="perm-delete-btn icon-btn" style="color: #dc2626;">
                            <span class="material-symbols-outlined text-base pointer-events-none">delete_forever</span>
                        </button>
                    </div>
                `;
                archiveContainer.appendChild(recordElement);
            });
        }

        function renderArchivedTests() {
            let archivedTests = JSON.parse(localStorage.getItem('archivedTestResults')) || [];
            archivedTestsContainer.innerHTML = '';

            if (archivedTests.length === 0) {
                archivedTestsContainer.innerHTML = `<p class="text-sm text-slate-500 dark:text-slate-400 text-center">ארכיון המבחנים ריק.</p>`;
                return;
            }

            archivedTests.forEach(test => {
                const testElement = document.createElement('div');
                testElement.className = 'archived-item';
                testElement.dataset.id = test.createdAt;
                testElement.innerHTML = `
                    <div class="archived-item-text">
                        <p class="archived-item-title">ציון: ${test.score} - ${test.level}</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400" style="font-size: 0.75rem;">${new Date(test.createdAt).toLocaleDateString('he-IL')}</p>
                    </div>
                    <div class="archived-item-actions">
                        <button title="שחזר" class="restore-test-btn icon-btn" style="color: #16a34a;">
                            <span class="material-symbols-outlined text-base pointer-events-none">unarchive</span>
                        </button>
                        <button title="מחק לצמיתות" class="perm-delete-test-btn icon-btn" style="color: #dc2626;">
                            <span class="material-symbols-outlined text-base pointer-events-none">delete_forever</span>
                        </button>
                    </div>
                `;
                archivedTestsContainer.appendChild(testElement);
            });
        }

        archivedTestsContainer.addEventListener('click', async (e) => {
            let archivedTests = JSON.parse(localStorage.getItem('archivedTestResults')) || [];
            const testId = e.target.closest('.archived-item')?.dataset.id;
            if (!testId) return;

            const index = archivedTests.findIndex(t => t.createdAt === testId);
            if (index === -1) return;

            // Restore button
            if (e.target.closest('.restore-test-btn')) {
                const [test] = archivedTests.splice(index, 1);
                let testResults = JSON.parse(localStorage.getItem('depressionTestResults')) || [];
                testResults.unshift(test);
                localStorage.setItem('depressionTestResults', JSON.stringify(testResults));
                localStorage.setItem('archivedTestResults', JSON.stringify(archivedTests));
                renderArchivedTests();
                return;
            }

            // Permanent delete button
            if (e.target.closest('.perm-delete-test-btn')) {
                const confirmed = await showCustomConfirm('פעולה זו תמחק את תוצאת המבחן לצמיתות. האם אתה בטוח?', 'אישור מחיקה');
                if (confirmed) {
                    archivedTests.splice(index, 1);
                    localStorage.setItem('archivedTestResults', JSON.stringify(archivedTests));
                    renderArchivedTests();
                }
            }
        });

        archiveContainer.addEventListener('click', async (e) => {
            let archivedRecords = JSON.parse(localStorage.getItem('archivedRecords')) || [];
            const recordId = e.target.closest('.archived-item')?.dataset.id;
            if (!recordId) return;

            const index = archivedRecords.findIndex(r => r.id.toString() === recordId);
            if (index === -1) return;

            // Restore button
            if (e.target.closest('.restore-btn')) {
                const [record] = archivedRecords.splice(index, 1);
                let thoughtRecords = JSON.parse(localStorage.getItem('thoughtRecords')) || [];
                thoughtRecords.unshift(record);
                localStorage.setItem('thoughtRecords', JSON.stringify(thoughtRecords));
                localStorage.setItem('archivedRecords', JSON.stringify(archivedRecords));
                renderArchivedRecords();
                return;
            }

            // Permanent delete button
            if (e.target.closest('.perm-delete-btn')) {
                const confirmed = await showCustomConfirm('פעולה זו תמחק את הרשומה לצמיתות. האם אתה בטוח?', 'אישור מחיקה');
                if (confirmed) {
                    archivedRecords.splice(index, 1);
                    localStorage.setItem('archivedRecords', JSON.stringify(archivedRecords)); // Save the updated array
                    renderArchivedRecords();
                }
            }
        });

        function showCustomModal(show) {
            if (show) {
                customModal.classList.remove('hidden');
                customModal.classList.add('flex');
            } else {
                customModal.classList.add('hidden');
                customModal.classList.remove('flex');
            }
        }

        function showCustomAlert(message, title = 'התראה') {
            customModalTitle.textContent = title;
            customModalMessage.textContent = message;
            customModalButtons.innerHTML = `<button id="modal-ok-btn" class="btn btn-primary" style="width: 120px;">אישור</button>`;
            document.getElementById('modal-ok-btn').addEventListener('click', () => {
                showCustomModal(false);
            });
            showCustomModal(true);
        }

        function showCustomConfirm(message, title = 'אישור פעולה') {
            customModalTitle.textContent = title;
            customModalMessage.textContent = message;
            customModalButtons.innerHTML = `
               <button id="modal-cancel-btn" class="btn btn-secondary btn-full">ביטול</button>
                <button id="modal-confirm-btn" class="btn btn-danger btn-full">מחק</button>
            `;
            showCustomModal(true);

            return new Promise((resolve) => {
                confirmResolve = resolve;
                document.getElementById('modal-confirm-btn').onclick = () => {
                    showCustomModal(false);
                    confirmResolve = null;
                    resolve(true);
                };
                document.getElementById('modal-cancel-btn').onclick = () => {
                    showCustomModal(false);
                    confirmResolve = null;
                    resolve(false);
                };
            });
        }

        exportBtn.addEventListener('click', exportToCsv);
        exportTestsBtn.addEventListener('click', exportTestsToCsv);
        renderArchivedRecords();
        renderArchivedTests();
    });

    // Basic dark mode persistence
    if (localStorage.getItem('darkMode') === 'true' || (!('darkMode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
    }
</script>
</body></html>